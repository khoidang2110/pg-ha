global
    maxconn 1000  # Tăng để hỗ trợ nhiều kết nối hơn
    log /dev/log local0

defaults
    mode tcp
    timeout connect 10s
    timeout client 30s
    timeout server 30s
    option log-health-checks

# PostgreSQL Primary - Write connections
frontend postgres_primary
    bind *:5432
    default_backend postgres_primary_backend

backend postgres_primary_backend
    mode tcp
    balance roundrobin
    option httpchk GET /primary
    server postgres1 postgres1:5432 check port 8008 inter 2000 rise 2 fall 3
    server postgres2 postgres2:5432 check port 8008 inter 2000 rise 2 fall 3 backup
    server postgres3 postgres3:5432 check port 8008 inter 2000 rise 2 fall 3 backup

# PostgreSQL Replica - Read-only connections
frontend postgres_replica
    bind *:5433
    default_backend postgres_replica_backend

backend postgres_replica_backend
    mode tcp
    balance leastconn  # Phân phối đến node có ít kết nối nhất
    option httpchk GET /replica
    server postgres1 postgres1:5432 check port 8008 inter 2000 rise 2 fall 3
    server postgres2 postgres2:5432 check port 8008 inter 2000 rise 2 fall 3
    server postgres3 postgres3:5432 check port 8008 inter 2000 rise 2 fall 3

# Patroni API for management
frontend patroni_api
    bind *:5000
    mode http
    default_backend patroni_api_backend

backend patroni_api_backend
    mode http
    balance roundrobin
    server postgres1 postgres1:8008 check
    server postgres2 postgres2:8008 check
    server postgres3 postgres3:8008 check

# Stats page
frontend stats
    bind *:8404
    mode http
    stats enable
    stats uri /
    stats refresh 30s
    stats admin if LOCALHOST